<div id="businessEditModal" class="modal" role="dialog" data-backdrop="static" data-keyboard="false">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<h4 class="modal-title">Edit Department</h4>
			</div>
			<div class="modal-body">
				<div class="row">
					<form>
						<div class="col-md-3">
							<div class="form-group" id="businessIDWrap">
								<label for="businessID">ID</label>
								<input type="text" class="form-control bus-value" id="businessID"/>
							</div>
							<div class="form-group">
								<label for="name">Name</label>
								<input type="text" class="form-control bus-value" id="name">
							</div>
							<div class="form-group">
								<label for="name">Display Name</label>
								<input type="text" class="form-control bus-value" id="displayName">
							</div>
							<div class="form-group">
								<label for="type">Type</label>
								<!--<input type="text" class="form-control bus-value" id="type">-->
								<select class="form-control bus-value select" id="type">
									<option value="">None</option>
									{% for e in businessTypes %}
										<option value="{{ e.type }}">{{ e.type }}</option>
									{% endfor %}
								</select>
							</div>
							<div class="form-group">
								<label for="costCenter">Cost Center</label>
								<input type="text" class="form-control bus-value" id="costCenter">
							</div>
							<div class="form-group">
								<label for="processLevel">Process Level</label>
								<input type="text" class="form-control bus-value" id="processLevel">
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="parentBusinessID">Parent Business</label>
								<select class="select2-ajax entity-type-select bus-value" data-type="parent-business" id="parentBusinessID">
									<option value="">None</option>
								</select>
							</div>
							<div class="form-group">
								<label for="directorID">Director</label>
								<select class="select2-ajax entity-type-select bus-value" data-type="employee" id="directorID">
									<option value="">None</option>
								</select>
							</div>
							<div class="form-group">
								<label for="vpID">VP</label>
								<select class="select2-ajax entity-type-select bus-value" data-type="employee" id="vpID">
									<option value="">None</option>
								</select>
							</div>
							<div class="form-group">
								<label for="property">Property</label>
								<!--<input type="text" class="form-control bus-value" id="property">-->
								<select class="form-control bus-value select" id="property">
									<option value="">None</option>
									{% for e in properties %}
										<option value="{{ e.property }}">{{ e.property }}</option>
									{% endfor %}
								</select>
							</div>
							<div class="form-group">
								<label for="propertyReportsTo">Property Reports To</label>
								<!--<input type="text" class="form-control bus-value" id="propertyReportsTo">-->
								<select class="form-control bus-value select" id="propertyReportsTo">
									<option value="">None</option>
									{% for e in propertyReportsTo %}
										<option value="{{ e.propertyReportsTo }}">{{ e.propertyReportsTo }}</option>
									{% endfor %}
								</select>
							</div>
							<div class="form-group">
								<label for="propertyLocation">Property Location</label>
								<!--<input type="text" class="form-control bus-value" id="propertyLocation">-->
								<select class="form-control bus-value select" id="propertyLocation">
									<option value="">None</option>
									{% for e in propertyLocations %}
										<option value="{{ e.propertyLocation }}">{{ e.propertyLocation }}</option>
									{% endfor %}
								</select>
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<label for="directions">Directions</label>
								<input type="text" class="form-control bus-value" id="directions">
							</div>
							<div class="form-group">
								<label for="intranetURL">Intranet URL</label>
								<input type="text" class="form-control bus-value" id="intranetURL">
							</div>
							<div class="form-group">
								<label for="webURL">Web URL</label>
								<input type="text" class="form-control bus-value" id="webURL">
							</div>
							<div class="form-group">
								<label for="hours">Hours</label>
								<input type="text" class="form-control bus-value" id="hours">
							</div>
							<div class="form-group">
								<label for="promoLine">Promo Line</label>
								<input type="text" class="form-control bus-value" id="promoLine">
							</div>
							<div class="form-group">
								<label for="midasID">Midas ID</label>
								<input type="text" class="form-control bus-value" id="midasID">
							</div>
						</div>
						<div class="col-md-3">
							<div class="form-group">
								<div class="checkbox">
									<label>
										<input type="checkbox" class="bus-value" id="isNew"> New
									</label>
								</div>
							</div>
							<div class="form-group">
								<div class="checkbox">
									<label>
										<input type="checkbox" class="bus-value" id="isActive"> Active
									</label>
								</div>
							</div>
							<div class="form-group">
								<div class="checkbox">
									<label>
										<input type="checkbox" class="bus-value" id="isBlind"> Blind
									</label>
								</div>
							</div>
							<div class="form-group">
								<div class="checkbox">
									<label>
										<input type="checkbox" class="bus-value" id="publicWebsite"> Public website
									</label>
								</div>
							</div>
							<div class="form-group">
								<div class="checkbox">
									<label>
										<input type="checkbox" class="bus-value" id="employeePortal"> Employee portal
									</label>
								</div>
							</div>
							<div class="form-group">
								<label for="source">Source</label>
								<input type="text" class="form-control bus-value" id="source">
							</div>
							<div class="form-group">
								<label for="created">Created</label>
								<input type="text" class="form-control bus-value" id="created" disabled>
							</div>
							<div class="form-group">
								<label for="lastUpdated">Updated</label>
								<input type="text" class="form-control bus-value" id="lastUpdated" disabled>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-danger pull-left" id="deleteBusinessBtn" data-businessID="">Delete</button>
				<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-primary" id="saveBusinessBtn" data-businessID="">Save</button>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
	var hasChildren = false;
	var isSourceUser = false;
	var canDelete = false;
	
	$(document).ready(function() {
		$("#saveBusinessBtn").click(function() {
			var data = {
				businessID: $(this).attr("data-businessID")
			};

			$(".bus-value").each(function(i, el) {
				el = $(el);
				var field = el.attr("id");

				if (el.is("input[type='text']") || el.is("select")) {
					data[field] = el.val();
					//console.log(field + ':' + value);
				}
				else if (el.is("input[type='checkbox']")) {
					data[field] = el.prop("checked");
					//console.log(field + ':' + value);
				}
			});

			//console.log(data);

			$.ajax({
				url: "/api/save-business",
				method: "POST",
				data: data
			}).done(function(response) {
				//console.log(response);
				$("#businessEditModal").modal("hide");
				location.reload();
			}).fail(function(response) {
				console.log(response.responseJSON);
				if (typeof response.responseJSON != 'undefined') {
					bsAlert("Error: " + response.responseJSON.error_msg, 'error');
				}
				else {
					bsAlert("Error: " + response.responseText, 'error');
				}
			});
		});
		
		$('#deleteBusinessBtn').click(function() {
			if (hasChildren === true) {
				bsAlert('You can not delete this department because it has children.', 'error');
				return;
			}
			
			if (canDelete === false) {
				bsAlert('You can not delete this department.', 'error');
				return;
			}

			var btn = $(this);

			bootbox.dialog({
				message: "Are you sure you want to delete this department and all associated data?<br/><br/>This action can not be undone.",
				title: "Delete Department",
				buttons: {
					success: {
						label: "Delete",
						className: "btn-danger",
						callback: function() {
							var data = {
								businessID: btn.attr('data-businessID')
							};

							//console.log(data);

							$.ajax({
								url: "/api/remove-business",
								method: "POST",
								data: data,
								dataType: 'json'
							}).done(function (response) {
								//console.log(response);
								$("#businessEditModal").modal("hide");
								location.reload();
							}).fail(function (response) {
								console.log(response);
								if (typeof response.responseJSON.error_msg != 'undefined') {
									bsAlert("Error: " + response.responseJSON.error_msg, 'error');
								}
								else {
									bsAlert("Error: " + response.responseText, 'error');
								}
							});
						}
					},
					main: {
						label: "Cancel",
						className: "btn-primary"
					}
				}
			});
		});
	});

	var initBusinessEditDialog = function(mode, businessId, values) {
		//console.log(values);
		if (mode == 'edit') {
			$('#businessEditModal .modal-title').text("Edit Department");
			
			hasChildren = false;
			isSourceUser = false;
			canDelete = false;
			
			$.each(values, function(name, value) {
				//console.log(name + ' = ' + value);
				
				if (name == 'children' && value.length > 0) {
					//console.log(value);
					hasChildren = true;
				}
				
				if (name == 'source' && value == 'User') {
					isSourceUser = true;
				}
				
				var el = $("#" + name);
				if (el.length) {
					if (el.is("select")) {
						if (el.hasClass('select2-ajax')) {
							var type = el.attr('data-type');
							initSelect2Ajax(el, type, {id: value, text: name});
						}
						else {
							el.val(value);
							setSelectOptionColor(el);
						}
					}
					else if (el.is("input[type='text']")) {
						//el.attr("value", value);
						el.val(value);
					}
					else if (el.is("input[type='checkbox']")) {
						if (value == true || value == "Yes") {
							el.prop('checked', true);
						}
						else {
							el.prop('checked', false);
						}
					}
				}
			});

			$("#saveBusinessBtn").attr("data-businessID", businessId);
			$("#deleteBusinessBtn").attr("data-businessID", businessId);
			
			$('#businessID').prop('disabled', true);
			$('#source').prop('disabled', true);
			$('#parentBusinessID').prop('disabled', false);
			
			if (isSourceUser || (values.costCenter == 0 && hasChildren == false)) {
				$('#name').prop('disabled', false);

				$('#deleteBusinessBtn').show();
				canDelete = true;
			}
			else {
				$('#name').prop('disabled', true);
				$('#directorID').prop('disabled', true);
				$('#vpID').prop('disabled', true);

				$('#deleteBusinessBtn').hide();
			}
			
			if (values.costCenter == 0) {
				$('#directorID').prop('disabled', false);
				$('#vpID').prop('disabled', false);
			}
			
			if (hasChildren) {
				$('#parentBusinessID').prop('disabled', true);
			}
		}
		else {
			$('#businessEditModal .modal-title').text("Add Department");

			$('.select2-ajax').each(function() {
				var type = $(this).attr('data-type');
				initSelect2Ajax($(this), type);
			});
			
			$('.bus-value').each(function() {
				var el = $(this);
				if (el.is("select")) {
					if (el.hasClass('select2-ajax')) {
						var type = el.attr('data-type');
						initSelect2Ajax(el, type);
					}
					else {
						el.val('');
						setSelectOptionColor(el);
					}
				}
				else if (el.is("input[type='text']")) {
					el.val('');
				}
				else if (el.is("input[type='checkbox']")) {
					el.prop('checked', false);
				}
			});

			$('#name').prop('disabled', false);
			$('#directorID').prop('disabled', false);
			$('#vpID').prop('disabled', false);

			$('#businessID').val('auto').prop('disabled', true);
			$('#source').val('User').prop('disabled', true);
			
			$('#created').val('1/1/2016');
			$('#lastUpdated').val('1/1/2016');

			$('#deleteBusinessBtn').hide();
		}
	}
</script>